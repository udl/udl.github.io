<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta charset="utf-8">
  <title>
    
      Introduction to Docker &ndash;
    
    Udo Groebner
  </title>

  <meta name="author" content="Udo Groebner" />
  <meta name="description" content="modern web tech" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48292287-1', 'udl.github.io');
    ga('send', 'pageview');

  </script>

  <link rel="alternate" type="application/rss+xml" href="/atom.xml" />

  <link rel="stylesheet" href="/css/fontawesome.min.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/base.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
  <link media="only screen and (max-device-width: 480px)" href="/css/mobile.css" type="text/css" rel="stylesheet" />
  <link media="only screen and (device-width: 768px)" href="/css/mobile.css" type="text/css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript" src="/js/application.js"></script>
</head>

<body>
  <section class="sidebar">
    <a href="/">
      <img src="http://gravatar.com/avatar/28edaff2e9ba39c943bba5fa199243e8?s=150" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span id="fname">Udo</span>
        <span id="lname">Groebner</span>
      </a>
    </section>

    <section class="meta">
      <a href="https://github.com/udl" target="_blank"><i class="icon icon-github"></i></a>
      <a href="/atom.xml"><i class="icon icon-rss"></i></a>
    </section>

    <section class="sections">
      <ul>
        <li><a href="/about.html">about</a></li>
        <li><a href="/">posts</a></li>
      </ul>
    </section>
  </section>

  <section class="content">
  <h1>
    <a href="/posts/docker">Introduction to Docker</a>
  </h1>

  <section class="byline">
    February 21, 2014
  </section>

  <p><img src="https://www.docker.io/static/img/homepage-docker-logo.png" alt="Docker whale"></p>

<h1>tl;dr</h1>

<p>This post gives a highlevel overview of <strong>docker</strong>. It also sums up what I&#39;ve learned setting up <strong>elasticsearch</strong>, <strong>neo4j</strong> and a ruby <strong>sinatra</strong> service in docker containers.</p>

<h1>What is docker?</h1>

<p>Docker is basically an open source toolset for creating and managing VM-like <a href="http://linuxcontainers.org/">linux containers (LXC)</a>.</p>

<p>The overall goal is to have <strong>cheap</strong>, <strong>portable</strong>, <strong>composable</strong>, <strong>single responsibility</strong> systems.</p>

<h3>cheap</h3>

<p>Linux containers are extremely lightweight compared to virtual machines, because they share some aspects of the hosts OS (like the kernel). This makes booting up a container really cheap and fast. If you&#39;re interested in a detailled performance analysis, you should read this <a href="http://dtrace.org/blogs/brendan/2013/01/11/virtualization-performance-zones-kvm-xen/">comparison</a>. It compares solaris zones, which are similar to linux containers, to xen and kvm.</p>

<h3>portable</h3>

<p><a href="http://tech-beta.slashdot.org/story/13/11/26/2317252/docker-07-runs-on-all-linux-distributions">Since version 0.7</a> docker containers run on all major linux distributions. As the system adds a layer on top of the hosts filesystem (called <em><a href="http://aufs.sourceforge.net/aufs.html">aufs</a></em>), it doesn&#39;t care about the used filesystem. This means you can create the container on your developer ubuntu system with ext4 filesystem and then deploy the final version to a fedora VM inside an amazon EC2 instance with ext3.</p>

<h3>composable</h3>

<p>Docker makes it easy to expose ports to the host system or other containers or let containers use disk volumes of each other. All this can be done with simple command line switches, you don&#39;t have to touch iptables or mtab.</p>

<h3>single responsibility</h3>

<p>Developers know the <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">single responsibility principle</a> from object oriented coding. The unix world knows it as <a href="http://en.wikipedia.org/wiki/Unix_philosophy">&quot;do one thing and do it well&quot;</a>.
This principle helps making your systems clear in what they do and easier to maintain.</p>

<p>For further reading on <em>what docker is</em> see this <a href="http://www.infoq.com/articles/docker-containers/">infoq article</a> or take a look at these slides:
<iframe src="http://www.slideshare.net/slideshow/embed_code/28618034" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe></p>

<h1>What docker is not?</h1>

<ul>
<li>officially production ready (although everyone and his mother is using it in
production already)</li>
<li>a full blown configuration management tool like chef or puppet (but
there&#39;s support for <a href="http://docs.docker.io/en/latest/use/puppet/">puppet</a> and chef)</li>
</ul>

<h1>Building blocks</h1>

<h3>Image</h3>

<p>An image is a <strong>read only</strong>, docker bootable system. Think of it as a
DVD-ROM.</p>

<h3>Container</h3>

<p>Once you boot an image, docker creates a container. Think of it as a VM.</p>

<h1>Leave theory, talk practice!</h1>

<h3>Install docker</h3>

<p>As docker is built on top of <a href="http://linuxcontainers.org/">linux containers (LXC)</a>, the best way to try it is on a linux computer.
You can use it on other OSes (like <a href="http://docs.docker.io/en/latest/installation/mac/">OS X</a>) (because it runs well in already virtualized environments), but I haven&#39;t tried that yet.
The installation is well documented, so I won&#39;t repeat that here.
Just take those 2 links and come back once you&#39;ve installed docker:</p>

<ul>
<li><a href="http://docs.docker.io/en/latest/installation/">docker.io</a></li>
<li><a href="https://www.digitalocean.com/community/articles/how-to-install-and-use-docker-getting-started/">digitalocean</a> </li>
</ul>

<h3>Run an image</h3>

<p>Now that you have docker installed, you&#39;re ready to roll!
When you type</p>

<div class="highlight"><pre><code class="bash">docker run base ping google.com
</code></pre></div>

<p>you should see something like this:</p>

<p><img src="http://udl.github.io/images/docker_base_ping.png" alt="running ping google on a base image"></p>

<p>Now what happens there?</p>

<div class="highlight"><pre><code class="bash">docker run base
</code></pre></div>

<p>tells docker to start a container from the <strong>base</strong> image. The cool thing is that you can pass a command to the container which it will execute: <em>ping google.com</em>.</p>

<p>You can try the same with</p>

<div class="highlight"><pre><code class="bash">docker run base ls -la
</code></pre></div>

<p>(Everything you can do on the command line: <a href="http://docs.docker.io/en/latest/reference/commandline/">Docker CLI reference</a>)</p>

<h3>I want more functionality</h3>

<p>There&#39;s not much included in the base image, because it is meant to serve as a starting point. There isn&#39;t even curl installed. The docker ecosystem provides you another nice thing: the 
<a href="https://index.docker.io/">docker index</a>.</p>

<p>This is a database of predefined images from the docker guys and users.
A quick search for <em>curl</em>, for example, brings this image up: <a href="https://index.docker.io/u/speg03/curl/">https://index.docker.io/u/speg03/curl/</a>.</p>

<p>You can install it with</p>

<div class="highlight"><pre><code class="bash">docker pull speg03/curl
</code></pre></div>

<p>and the result:</p>

<p><img src="http://udl.github.io/images/docker_pull.png" alt="installing a new docker image"></p>

<p>Now you can <em>curl</em>, finally!</p>

<div class="highlight"><pre><code class="bash">docker run -t -i speg03/curl -XGET http://google.com
</code></pre></div>

<p>which yields</p>

<p><img src="http://udl.github.io/images/docker_curl.png" alt="result of curl from the docker image"></p>

<p>But wait, isn&#39;t there the <em>curl</em> command missing? You&#39;re absolutely right.</p>

<p>If you take a look at the <a href="https://github.com/speg03/docker-curl/blob/master/Dockerfile">Dockerfile</a>, you can see the <strong>ENTRYPOINT</strong> statement at the bottom:</p>

<div class="highlight"><pre><code class="bash">ENTRYPOINT <span class="o">[</span><span class="s2">&quot;curl&quot;</span><span class="o">]</span>
</code></pre></div>

<p>This command get&#39;s executed automatically when you spawn a container from an image. Every container has exactly <strong>one</strong> purpose, right? So this is where it goes. Let&#39;s move on to the next lesson: the Dockerfiles.</p>

<h3>Create your own shiny new image with a Dockerfile</h3>

<p>Dockerfiles define, how an image can be built. You could compare it to a
Makefile. A Dockerfile let&#39;s you automate the tasks, that you could as
well do manually. The nice thing is, that they also serve as a
documentation for your images.</p>

<p>Every Dockerfile defines an image to start from:</p>

<div class="highlight"><pre><code class="bash">FROM tpires/neo4j
</code></pre></div>

<p>defines <a href="https://index.docker.io/u/tpires/neo4j/">https://index.docker.io/u/tpires/neo4j/</a> as starting point.</p>

<p>Let&#39;s say you&#39;d like to add the neo4j authentication extension to the container:</p>

<div class="highlight"><pre><code class="bash">ADD authentication-extension-2.0.0-1.0-SNAPSHOT.jar /usr/share/neo4j/plugins/authentication-extension-2.0.0-1.0-SNAPSHOT.jar
</code></pre></div>

<p>This statement copies the file <em>authentication-extension-2.0.0-1.0-SNAPSHOT.jar</em>, that&#39;s assumed to reside in the same directory as the Dockerfile, to the directory <em>/usr/share/...</em>.</p>

<p>A complete list of available commands can be found in the <a href="http://docs.docker.io/en/latest/reference/builder/">Dockerfile reference</a>.
You might also check out the <a href="http://crosbymichael.com/dockerfile-best-practices.html">Dockerfile best practices</a>.</p>

<h3>Handling configuration</h3>

<p>Most applications need some form of configuration. There seems to be no
one-size-fits-all solution with docker yet.
I&#39;d like to show you two (and a half) possible solutions for this problem:</p>

<h4>Configuration via environment parameters</h4>

<p>As mentioned earlier, docker makes it easy to pass information to the
container via CLI parameters.</p>

<div class="highlight"><pre><code class="bash">docker run -e <span class="nv">DATABASE_SERVER</span><span class="o">=</span>http://localhost:9876 ubuntu env
</code></pre></div>

<p><img src="http://udl.github.io/images/docker_env.png" alt="environment passing to a container"></p>

<p>This way of providing configuration is definitely the cleanest and
therefore <a href="http://12factor.net/">recommended</a> way. But there may be
times, when you have to put some aspects of configuration into an image.</p>

<h4>Configuration baked into the container</h4>

<p>This solution is obviously completely self-contained. So the only thing
you need for running it, is a docker installation. The drawback is, that
you have to create a new image whenever the configuration changes.</p>

<p>You can achieve this by copying the necessary config files from your
working directory into the image while building it.</p>

<p>In our neo4j example, this would be:</p>

<div class="highlight"><pre><code class="bash">ADD neo4j-server.properties /etc/neo4j/neo4j-server.properties
</code></pre></div>

<h4>Mounting configuration files from the host system</h4>

<p>While being possible, this is certainly not the best option for finished
containers. But this solution can come in handy while developing a
&quot;Configuration baked in&quot; image. You don&#39;t have to re-build the image
every time you change a configuration parameter. A simple restart with a
fresh container is enough.</p>

<p>You can mount a directory from your host system to the container with
<strong>-v</strong> command line switch:</p>

<div class="highlight"><pre><code class="bash">docker run -v /root:/mnt/data ubuntu ls /mnt/data
</code></pre></div>

<p>With this command, you&#39;re able to access the hosts <em>/root</em> directory as
<em>/mnt/data</em> inside your container. For development, you could symlink all necessary configuration files to such a mounted directory.</p>

<p>See also this <a href="https://groups.google.com/forum/#!msg/docker-user/FyCWLC38Ueg/4vG75mCYSiAJ">discussion</a>.</p>

<h3>Let it run</h3>

<p>Now that we&#39;ve created an image with a database server and adapted its
configuration, we&#39;d like to let it run!</p>

<div class="highlight"><pre><code class="bash">docker run -p 9200:9200 -p 9300:9300 -name elasticsearch -d dockerfile/elasticsearch
</code></pre></div>

<p>starts a container from the image <em>dockerfile/elasticsearch</em> and maps
the exposed port 9200 to the hosts port 9200. We don&#39;t even have to
think about iptables. It just works.</p>

<p>When you decide, that you need another elasticsearch instance, you could
easily map the exposed ports 9200 and 9300 to 9201 and 9301 of the host.</p>

<p>The <strong>-d</strong> switch runs the container in the background, so your console
doesn&#39;t get attached to it.</p>

<p>You can list <strong>all running containers</strong> with</p>

<div class="highlight"><pre><code class="bash">docker ps
</code></pre></div>

<p>All known containers (also the exited ones) are listed by the command</p>

<div class="highlight"><pre><code class="bash">docker ps -a
</code></pre></div>

<h3>But, Mum, I&#39;d like to store data!</h3>

<p>The thing with containers is, that they are meant to be disposable. Databases, on the other hand, store their data on the filesystem of the same machine by default.
What does this mean? Every time you start a container from an image, you will get a fresh container. With a clean file system.
While this is good for application servers, it&#39;s very good for databases or similar applications.</p>

<p>Meet the docker <a href="http://crosbymichael.com/advanced-docker-volumes.html">volumes</a>!
The idea is: when everything is a container, why should your data store
be different?</p>

<p>So you can basically create a new container, which can quit immediately;
we just need the container:</p>

<div class="highlight"><pre><code class="bash">docker run -name neo4j-data-volume busybox <span class="nb">true</span>
</code></pre></div>

<p>This command creates a new container from the <em>busybox</em> (a very small) image with the name <strong>neo4j-data-volume</strong>.
You might have noticed in <em>docker ps</em>, that docker creates container names itself when you don&#39;t specify one.</p>

<p>Our neo4j server Dockerfile specifies, that the container expects a
volume, which it will mount as /data:</p>

<div class="highlight"><pre><code class="bash">VOLUME /data
</code></pre></div>

<p>This volume could be an external moint (via -v command line option, as
seen earlier) or a volume from another container:</p>

<div class="highlight"><pre><code class="bash">docker run -volumes-from neo4j-data-volume -d tpires/neo4j
</code></pre></div>

<p>Note, that the container <em>neo4j-data-volume</em> doesn&#39;t need to be running any more.
You can access the filesystem of this container at the <em>/data</em> path.</p>

<p>Now you can restart the neo4j server any time you like <strong>and</strong> copy/move the
neo4j-data-volume to any other host. True containerization!</p>

<h3>Access ports from another container</h3>

<p>Your super shiny NoSQL-Graph-RDF-RDBMS-YouNameIt-AllInOne database is of
no use, when you can&#39;t access it from your application.</p>

<p>But, you&#39;ve guessed it, docker provides a solution to this problem as
well. It&#39;s quite easy to link containers to each other.</p>

<p>I won&#39;t go into detail on that too much, as the explanations in
<a href="http://docs.docker.io/en/latest/use/working_with_links_names/">this article</a> are really good and clear.</p>

<h3>Misc. tips&#39;n&#39;tricks</h3>

<h4>Remove all containers that have exited</h4>

<div class="highlight"><pre><code class="bash">docker rm <span class="sb">`</span>docker ps -a  <span class="p">|</span> grep Exit <span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span><span class="sb">`</span>
</code></pre></div>

<p><strong>CAUTION</strong> This command also removes containers that you might still
need as data volumes!</p>

<p>I&#39;ve named all data volumes with the scheme <em>...-data-volume</em>, so the
following command doesn&#39;t destroy those:</p>

<div class="highlight"><pre><code class="bash">docker rm <span class="sb">`</span>docker ps -a  <span class="p">|</span> grep Exit <span class="p">|</span> grep -v data-volume <span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span><span class="sb">`</span>
</code></pre></div>

<h4>Where are docker images stored, actually?</h4>

<p>That question (and some related ones) is answered here in detail:
<a href="http://blog.thoward37.me/articles/where-are-docker-images-stored/">http://blog.thoward37.me/articles/where-are-docker-images-stored/</a></p>

<h1>Issues I&#39;ve come across</h1>

<ul>
<li>Restarting named containers yields: <em>Error: create: Conflict, The name NAME is already assigned to c01db478637c. You have to delete (or rename) that container to be able to assign NAME to a container again.</em></li>
<li>No obvious way to inspect an image when entrypoint is defined</li>
<li>Lacking best practices due to young age of docker</li>
<li><a href="http://blog.docker.io/2013/08/containers-docker-how-secure-are-they/">Security</a> takes some aspects to be aware of.</li>
</ul>

<h1>Conclusion</h1>

<p>I&#39;m pretty sure, I forgot to mention some really important things. But
hey, this is the internetz. There&#39;s lots of other resources out there.
I hope, you have as much fun and excitement using docker as I have.
Thanks for staying with me that long, I hope you find this introduction
useful.</p>

<p>For further reading visit the following sites:</p>

<ul>
<li><a href="http://samsaffron.com/archive/2013/11/07/discourse-in-a-docker-container">http://samsaffron.com/archive/2013/11/07/discourse-in-a-docker-container</a></li>
<li><a href="https://medium.com/code-adventures/65136a4a9d8">https://medium.com/code-adventures/65136a4a9d8</a></li>
<li><a href="http://kencochrane.net/blog/2013/08/the-docker-guidebook/">http://kencochrane.net/blog/2013/08/the-docker-guidebook/</a></li>
</ul>


    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'udlgithubio'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>
<div class="footer">
  <div class="contact">
    <p>
      Software developer @ <a href="http://crealytics.com">crealytics GmbH</a><br />
      (And yes, we're <a href="http://crealytics.com/jobs.html">hiring</a>)<br />
    </p>
  </div>
</div>


</body>

</html>
